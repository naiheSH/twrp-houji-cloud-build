name: TWRP 16 Builder

on:
  workflow_dispatch:
    inputs:
      TWRP_MANIFEST_URL:
        description: "TWRP manifest url"
        required: true
        default: "https://github.com/TWRP-Test/platform_manifest_twrp_aosp"
      TWRP_MANIFEST_BRANCH:
        description: "TWRP branch"
        required: true
        default: "twrp-16.0"
      DEVICE_TREE_URL:
        description: "Device tree url"
        required: true
        default: "https://github.com/wajidsnaa/android_device_xiaomi_houji"  # 小米14设备树
      DEVICE_TREE_BRANCH:
        description: "Device tree branch"
        required: true
        default: "main"  # 适配wajidsnaa仓库默认分支
      DEVICE_PATH:
        description: "Device path device/"
        required: true
        default: "xiaomi/houji"  # 小米14设备路径
      DEVICE_NAME:
        description: "Device name"
        required: true
        default: "houji"  # 小米14代号
      LUNCH_TARGET:
        description: "lunch twrp_ (default same as device name)"
        required: false
        default: "houji"
      BUILD_PARTITION:
        description: "Build partition"
        required: true
        default: "recovery"
      COMMON_DEVICE_TREE_URL:
        description: "Common device tree url (SM8650)"
        required: true
        default: "https://github.com/lolipuru/device_xiaomi_sm8650-common"
      COMMON_DEVICE_BRANCH:
        description: "Common device tree branch"
        required: true
        default: "lineage-23.0"
      COMMON_VENDOR_URL:
        description: "Common vendor url (SM8650)"
        required: true
        default: "https://github.com/lolipuru/vendor_xiaomi_sm8650-common"
      DEVICE_VENDOR_URL:
        description: "Device vendor url (houji)"
        required: true
        default: "https://github.com/lolipuru/vendor_xiaomi_houji"

jobs:
  build:
    runs-on: ubuntu-22.04  # 指定稳定版本，避免ubuntu-latest兼容性问题
    permissions:
      contents: write
    steps:
      # 更新并安装依赖
      - name: Update apt sources
        run: |
          # 强制使用官方 Ubuntu 镜像源
          sudo sed -i 's|http://azure.archive.ubuntu.com/ubuntu|http://archive.ubuntu.com/ubuntu|' /etc/apt/sources.list
          sudo apt update

      - name: Install dependencies
        run: |
          # 安装构建所需的依赖和工具
          sudo apt install -y linux-modules-extra-$(uname -r) zram-tools
          sudo apt install -y repo bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev libelf-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3-pip python3-dev libffi-dev libssl-dev zlib1g-dev openjdk-17-jdk python3-protobuf
          pip3 install pycairo
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      # 设置 ccache
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          create-symlink: true
          max-size: "60G"

      # 设置 zram
      - name: Setup zram
        run: |
          sudo apt install linux-modules-extra-$(uname -r) zram-tools -y
          sudo modprobe zram
          sudo sed -i 's/^#PERCENT=50/PERCENT=90/' /etc/default/zramswap
          sudo sed -i 's/^#PRIORITY=100/PRIORITY=1000/' /etc/default/zramswap
          sudo systemctl restart zramswap
          zramctl

      # 同步 TWRP 源代码
      - name: Sync TWRP-16.0 source (with retry)
        run: |
          repo init -u ${{ github.event.inputs.TWRP_MANIFEST_URL }} -b ${{ github.event.inputs.TWRP_MANIFEST_BRANCH }} --depth=1 || repo init -u ${{ github.event.inputs.TWRP_MANIFEST_URL }} -b ${{ github.event.inputs.TWRP_MANIFEST_BRANCH }} --depth=1
          (while true; do echo "$(date +%T) Syncing source..."; sleep 60; done) &
          TIP_PID=$!
          repo sync -j$(nproc) --no-clone-bundle --no-tags --force-sync || repo sync -j$(nproc) --no-clone-bundle --no-tags --force-sync
          kill $TIP_PID && exit 0

      # 导入设备树及依赖项
      - name: Import device tree & dependencies (小米14适配)
        run: |
          mkdir -p device/xiaomi vendor/xiaomi
          git clone ${{ github.event.inputs.DEVICE_TREE_URL }} -b ${{ github.event.inputs.DEVICE_TREE_BRANCH }} device/${{ github.event.inputs.DEVICE_PATH }}
          git clone -b ${{ github.event.inputs.COMMON_DEVICE_BRANCH }} ${{ github.event.inputs.COMMON_DEVICE_TREE_URL }} device/xiaomi/sm8650-common
          git clone -b ${{ github.event.inputs.COMMON_DEVICE_BRANCH }} ${{ github.event.inputs.COMMON_VENDOR_URL }} vendor/xiaomi/sm8650-common
          git clone -b ${{ github.event.inputs.COMMON_DEVICE_BRANCH }} ${{ github.event.inputs.DEVICE_VENDOR_URL }} vendor/xiaomi/houji

      # 注入 TWRP 配置
      - name: Inject TWRP-16.0 config (小米14专属)
        working-directory: device/${{ github.event.inputs.DEVICE_PATH }}
        run: |
          cat > twrp.fstab << EOF
          /boot           /dev/block/bootdevice/by-name/boot           ext4    defaults
          /recovery       /dev/block/bootdevice/by-name/recovery       ext4    defaults
          /system         /dev/block/bootdevice/by-name/system         ext4    ro,barrier=1
          /vendor         /dev/block/bootdevice/by-name/vendor         ext4    ro,barrier=1
          /odm            /dev/block/bootdevice/by-name/odm            ext4    ro,barrier=1
          /product        /dev/block/bootdevice/by-name/product        ext4    ro,barrier=1
          /metadata       /dev/block/bootdevice/by-name/metadata       ext4    defaults
          /userdata       /dev/block/bootdevice/by-name/userdata       ext4    encryptable=/dev/block/bootdevice/by-name/metadata
          /cache          /dev/block/bootdevice/by-name/cache          ext4    defaults
          /misc           /dev/block/bootdevice/by-name/misc           ext4    defaults
          /vendor_dlkm    /dev/block/bootdevice/by-name/vendor_dlkm    ext4    ro,barrier=1
          EOF
          cat >> BoardConfig.mk << EOF
          TW_DEVICE_VERSION := 3.7.1_16-01
          TW_SCREEN_RESOLUTION := 2720x1260
          TW_INPUT_BLACKLIST := "hbtp_vm"
          TW_INCLUDE_USB_OTG := true
          TW_EXCLUDE_DEFAULT_USB_INIT := true
          AVB_DISABLE := true
          TARGET_RECOVERY_FSTAB := \$(DEVICE_PATH)/twrp.fstab
          TW_EXCLUDE_AAPT := true
          TARGET_KERNEL_HEADERS := device/xiaomi/sm8650-common/kernel-headers
          TARGET_PLATFORM_VERSION := 16
          TARGET_USES_ANDROID_16 := true
          TARGET_RECOVERY_DEVICE := houji
          TW_IGNORE_ANDROID16_AAPT := true
          TW_DISABLE_SELINUX_CHECK := true
          TARGET_DISABLE_DM_VERITY := true
          TARGET_DISABLE_FORCED_ENCRYPTION := true
          EOF
          cat > AndroidProducts.mk << EOF
          PRODUCT_MAKEFILES := \
              \$(LOCAL_DIR)/twrp_houji.mk
          COMMON_LUNCH_CHOICES := \
              twrp_houji-eng
          EOF
          cat > twrp_houji.mk << EOF
          \$(call inherit-product, device/xiaomi/houji/device.mk)
          \$(call inherit-product, bootable/recovery-twrp/config/common.mk)
          \$(call inherit-product, device/xiaomi/sm8650-common/common.mk)
          PRODUCT_NAME := twrp_houji
          PRODUCT_DEVICE := houji
          PRODUCT_BRAND := Xiaomi
          PRODUCT_MODEL := Xiaomi 14
          PRODUCT_MANUFACTURER := Xiaomi
          PRODUCT_PLATFORM_VERSION := 16
          EOF

