name: 小米14 TWRP云编译（TWRP-16.0+Android 16）
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 支持手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 检查配置文件
        uses: actions/checkout@v4

      - name: 安装Android 16编译依赖（增强版）
        run: |
          sudo apt-get update
          # 基础依赖+Android 16专属依赖
          sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev libelf-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3-pip python3-dev libffi-dev libssl-dev zlib1g-dev openjdk-17-jdk
          pip3 install pycairo protobuf==3.20.3  # Android 16需protobuf特定版本
          # 安装repo工具
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "~/bin" >> $GITHUB_PATH

      - name: 同步TWRP-16.0源码（Android 16底包）
        run: |
          mkdir -p twrp-16-src && cd twrp-16-src
          # 初始化TWRP-16.0分支（适配Android 16）
          repo init -u https://github.com/TWRP-Test/platform_manifest_twrp_aosp.git -b twrp-16.0 --depth=1
          # 同步源码（启用多线程+断点续传）
          repo sync -j$(nproc) --no-clone-bundle --no-tags --force-sync

      - name: 导入小米14设备树与依赖（兼容Android 16）
        run: |
          cd twrp-16-src
          mkdir -p device/xiaomi vendor/xiaomi
          # 1. 小米14专属设备树（wajidsnaa版）
          git clone https://github.com/wajidsnaa/android_device_xiaomi_houji.git device/xiaomi/houji/xiaomi/houji
          # 2. SM8650通用依赖（lineage-23.0分支，兼容Android 16）
          git clone -b lineage-23.0 https://github.com/lolipuru/device_xiaomi_sm8650-common.git device/xiaomi/sm8650-common
          # 3. SM8650通用Vendor（Android 16适配版）
          git clone -b lineage-23.0 https://github.com/lolipuru/vendor_xiaomi_sm8650-common.git vendor/xiaomi/sm8650-common
          # 4. 小米14专属Vendor
          git clone -b lineage-23.0 https://github.com/lolipuru/vendor_xiaomi_houji.git vendor/xiaomi/houji

      - name: 注入TWRP-16.0适配配置（关键）
        run: |
          cd twrp-16-src/device/xiaomi/houji
          # 1. 优化twrp.fstab（Android 16分区兼容）
          cat > twrp.fstab << EOF
          /boot           /dev/block/bootdevice/by-name/boot           ext4    defaults
          /recovery       /dev/block/bootdevice/by-name/recovery       ext4    defaults
          /system         /dev/block/bootdevice/by-name/system         ext4    ro,barrier=1
          /vendor         /dev/block/bootdevice/by-name/vendor         ext4    ro,barrier=1
          /odm            /dev/block/bootdevice/by-name/odm            ext4    ro,barrier=1
          /product        /dev/block/bootdevice/by-name/product        ext4    ro,barrier=1
          /metadata       /dev/block/bootdevice/by-name/metadata       ext4    defaults
          /userdata       /dev/block/bootdevice/by-name/userdata       ext4    encryptable=/dev/block/bootdevice/by-name/metadata
          /cache          /dev/block/bootdevice/by-name/cache          ext4    defaults
          /misc           /dev/block/bootdevice/by-name/misc           ext4    defaults
          /vendor_dlkm    /dev/block/bootdevice/by-name/vendor_dlkm    ext4    ro,barrier=1  # Android 16新增分区
          EOF
          # 2. BoardConfig.mk添加Android 16+TWRP-16.0变量
          cat >> BoardConfig.mk << EOF
          # TWRP-16.0核心配置
          TW_DEVICE_VERSION := 3.7.0_16-01
          TW_SCREEN_RESOLUTION := 2720x1260
          TW_INPUT_BLACKLIST := "hbtp_vm"
          TW_INCLUDE_USB_OTG := true
          TW_EXCLUDE_DEFAULT_USB_INIT := true
          TW_SUPPORT_INPUT_1_1 := true
          AVB_DISABLE := true
          TARGET_RECOVERY_FSTAB := $(DEVICE_PATH)/twrp.fstab
          TW_EXCLUDE_AAPT := true
          TARGET_KERNEL_HEADERS := device/xiaomi/sm8650-common/kernel-headers
          # Android 16适配
          TARGET_PLATFORM_VERSION := 16
          TARGET_USES_ANDROID_16 := true
          BOARD_HAS_LARGE_FILESYSTEM := true
          TARGET_RECOVERY_DEVICE := houji
          # 解决Android 16库依赖冲突
          TW_IGNORE_ANDROID16_AAPT := true
          TW_DISABLE_SELINUX_CHECK := true
          EOF
          # 3. 修改device.mk继承TWRP-16.0依赖
          echo '$(call inherit-product, bootable/recovery-twrp/config/common.mk)' >> device.mk
          echo '$(call inherit-product, device/xiaomi/sm8650-common/common.mk)' >> device.mk
          # 4. 配置产物编译规则
          cat > AndroidProducts.mk << EOF
          PRODUCT_MAKEFILES := \
              $(LOCAL_DIR)/twrp_houji.mk
          COMMON_LUNCH_CHOICES := \
              twrp_houji-eng
          EOF
          cat > twrp_houji.mk << EOF
          $(call inherit-product, device/xiaomi/houji/device.mk)
          PRODUCT_NAME := twrp_houji
          PRODUCT_DEVICE := houji
          PRODUCT_BRAND := Xiaomi
          PRODUCT_MODEL := Xiaomi 14
          PRODUCT_MANUFACTURER := Xiaomi
          PRODUCT_PLATFORM_VERSION := 16  # 声明Android 16版本
          EOF

      - name: 编译TWRP-16.0（启用ccache加速）
        run: |
          cd twrp-16-src
          export USE_CCACHE=1
          export CCACHE_EXEC=$(which ccache)
          ccache -M 60G  # Android 16编译需更大缓存
          source build/envsetup.sh
          lunch twrp_houji-eng
          mka recoveryimage -j$(nproc)

      - name: 上传Android 16版TWRP产物
        uses: actions/upload-artifact@v4
        with:
          name: TWRP-Xiaomi14-TWRP16.0-Android16
          path: twrp-16-src/out/target/product/houji/recovery.img
          retention-days: 30
