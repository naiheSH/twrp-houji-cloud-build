name: TWRP 16 Builder - houji (Xiaomi 14)

on:
  workflow_dispatch:
    inputs:
      TWRP_MANIFEST_URL:
        description: 'TWRP manifest url'
        required: true
        default: 'https://github.com/TWRP-Test/platform_manifest_twrp_aosp'
      TWRP_MANIFEST_BRANCH:
        description: 'TWRP manifest branch'
        required: true
        default: 'twrp-16.0'

      DEVICE_TREE_URL:
        description: 'Device tree repo (device_xiaomi_houji)'
        required: true
        default: 'https://github.com/wajidsnaa/android_device_xiaomi_houji'
      DEVICE_TREE_BRANCH:
        description: 'Device tree branch'
        required: true
        default: 'twrp-13.0'

      COMMON_TREE_URL:
        description: 'Common tree repo (device_xiaomi_sm8650-common)'
        required: true
        default: 'https://github.com/lolipuru/device_xiaomi_sm8650-common'
      COMMON_TREE_BRANCH:
        description: 'Common tree branch'
        required: true
        default: 'twrp-13.0'

      KERNEL_URL:
        description: 'Optional kernel repo url (leave empty if not used)'
        required: false
        default: ''
      KERNEL_BRANCH:
        description: 'Kernel branch'
        required: false
        default: 'main'
      VENDOR_URL:
        description: 'Optional vendor repo url (leave empty if not used)'
        required: false
        default: ''
      VENDOR_BRANCH:
        description: 'Vendor branch'
        required: false
        default: 'main'

      DEVICE_PATH:
        description: 'Device path under device/ (e.g. xiaomi/houji)'
        required: true
        default: 'xiaomi/houji'
      DEVICE_NAME:
        description: 'Device name (folder name, e.g. houji)'
        required: true
        default: 'houji'

      LUNCH_TARGET:
        description: 'lunch twrp_ target (default device name)'
        required: false
        default: ''

      BUILD_PARTITION:
        description: 'Build partition (recovery / boot / vendor_boot)'
        required: true
        default: 'recovery'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      CCACHE_MAXSIZE: 5G

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Show build info
      run: |
        if [ -n "${{ github.event.inputs.LUNCH_TARGET }}" ]; then
          echo "LUNCH_TARGET=${{ github.event.inputs.LUNCH_TARGET }}" >> "$GITHUB_ENV"
        else
          echo "LUNCH_TARGET=${{ github.event.inputs.DEVICE_NAME }}" >> "$GITHUB_ENV"
        fi
        echo BUILD_DATE=$(date +%F) >> "$GITHUB_ENV"

    - name: Cleanup
      uses: rokibhasansagar/slimhub_actions@main

    - name: Maximize build space
      uses: easimon/maximize-build-space@master

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ${{ runner.os }}-ccache-${{ github.ref }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-
    - uses: hendrikmuhs/ccache-action@v1.2
      with:
        create-symlink: true

    - name: Setup zram
      run: |
        sudo apt update
        sudo apt install -y linux-modules-extra-$(uname -r) zram-tools || true
        sudo modprobe zram || true
        sudo sed -i 's/^#PERCENT=50/PERCENT=90/' /etc/default/zramswap || true
        sudo sed -i 's/^#PRIORITY=100/PRIORITY=1000/' /etc/default/zramswap || true
        sudo systemctl restart zramswap || true

    - name: Install build packages
      run: |
        sudo apt update
        sudo apt install -y repo git-core git python3 python3-pip curl
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"

    - name: Repo init
      run: |
        repo init -u "${{ github.event.inputs.TWRP_MANIFEST_URL }}" -b "${{ github.event.inputs.TWRP_MANIFEST_BRANCH }}" --depth=1

    - name: Repo sync
      run: |
        timeout 120m repo sync -c -j6 --no-tags

    - name: Clone device tree
      run: |
        mkdir -p device/${{ github.event.inputs.DEVICE_PATH }}
        git clone "${{ github.event.inputs.DEVICE_TREE_URL }}" -b "${{ github.event.inputs.DEVICE_TREE_BRANCH }}" "device/${{ github.event.inputs.DEVICE_PATH }}" || \
        git clone "${{ github.event.inputs.DEVICE_TREE_URL }}" "device/${{ github.event.inputs.DEVICE_PATH }}"

    - name: Clone common tree
      run: |
        mkdir -p device/xiaomi/sm8650-common
        git clone "${{ github.event.inputs.COMMON_TREE_URL }}" -b "${{ github.event.inputs.COMMON_TREE_BRANCH }}" device/xiaomi/sm8650-common || \
        git clone "${{ github.event.inputs.COMMON_TREE_URL }}" device/xiaomi/sm8650-common

    - name: Optional: clone kernel/vendor
      run: |
        if [ -n "${{ github.event.inputs.KERNEL_URL }}" ]; then
          git clone "${{ github.event.inputs.KERNEL_URL }}" -b "${{ github.event.inputs.KERNEL_BRANCH }}" kernel || \
          git clone "${{ github.event.inputs.KERNEL_URL }}" kernel
        fi

        if [ -n "${{ github.event.inputs.VENDOR_URL }}" ]; then
          git clone "${{ github.event.inputs.VENDOR_URL }}" -b "${{ github.event.inputs.VENDOR_BRANCH }}" vendor || \
          git clone "${{ github.event.inputs.VENDOR_URL }}" vendor
        fi

    - name: Setup build environment
      run: |
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        export USE_CCACHE=1
        export CCACHE_EXEC=$(command -v ccache)

    - name: Build TWRP
      run: |
        lunch twrp_${{ env.LUNCH_TARGET }} || exit 1
        BUILD_PART=${{ github.event.inputs.BUILD_PARTITION }}
        m ${BUILD_PART}image || m ${BUILD_PART}

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${{ github.event.inputs.BUILD_PARTITION }}.img
        name: TWRP-16-${{ github.event.inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}
        tag_name: ${{ env.BUILD_DATE }}-${{ github.run_id }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
