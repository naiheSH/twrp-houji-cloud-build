name: TWRP 16 Builder - houji (Xiaomi 14)

on:
  workflow_dispatch:
    inputs:
      # TWRP manifest (主源码)
      TWRP_MANIFEST_URL:
        description: 'TWRP manifest url'
        required: true
        default: 'https://github.com/TWRP-Test/platform_manifest_twrp_aosp'
      TWRP_MANIFEST_BRANCH:
        description: 'TWRP manifest branch'
        required: true
        default: 'twrp-16.0'

      # 设备专用 device tree（默认使用你给的仓库）
      DEVICE_TREE_URL:
        description: 'Device tree repo (device_xiaomi_houji)'
        required: true
        default: 'https://github.com/wajidsnaa/android_device_xiaomi_houji'
      DEVICE_TREE_BRANCH:
        description: 'Device tree branch'
        required: true
        default: 'twrp-13.0'

      # common tree (sm8650-common)
      COMMON_TREE_URL:
        description: 'Common tree repo (device_xiaomi_sm8650-common)'
        required: true
        default: 'https://github.com/lolipuru/device_xiaomi_sm8650-common'
      COMMON_TREE_BRANCH:
        description: 'Common tree branch'
        required: true
        default: 'twrp-13.0'

      # 可选：kernel / vendor / extra repos（若你有具体仓库可填写）
      KERNEL_URL:
        description: 'Optional kernel repo url (leave empty if not used)'
        required: false
        default: ''
      KERNEL_BRANCH:
        description: 'Kernel branch'
        required: false
        default: 'main'
      VENDOR_URL:
        description: 'Optional vendor repo url (leave empty if not used)'
        required: false
        default: ''
      VENDOR_BRANCH:
        description: 'Vendor branch'
        required: false
        default: 'main'

      DEVICE_PATH:
        description: 'Device path under device/ (e.g. xiaomi/houji)'
        required: true
        default: 'xiaomi/houji'
      DEVICE_NAME:
        description: 'Device name (folder name, e.g. houji)'
        required: true
        default: 'houji'

      LUNCH_TARGET:
        description: 'lunch twrp_ target (default device name)'
        required: false
        default: ''

      BUILD_PARTITION:
        description: 'Build partition (recovery / boot / vendor_boot)'
        required: true
        default: 'recovery'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      CCACHE_MAXSIZE: 5G
    steps:

    - name: Checkout (workflow)
      uses: actions/checkout@v4

    - name: Show build info
      run: |
        if [ -n "${{ github.event.inputs.LUNCH_TARGET }}" ]; then
          echo "LUNCH_TARGET=${{ github.event.inputs.LUNCH_TARGET }}" >> "$GITHUB_ENV"
        else
          echo "LUNCH_TARGET=${{ github.event.inputs.DEVICE_NAME }}" >> "$GITHUB_ENV"
        fi
        {
          echo 'BUILD_INFO<<EOF'
          echo
          echo Manifest url: ${{ github.event.inputs.TWRP_MANIFEST_URL }}
          echo Manifest branch: ${{ github.event.inputs.TWRP_MANIFEST_BRANCH }}
          echo Device tree url: ${{ github.event.inputs.DEVICE_TREE_URL }}
          echo Device tree branch: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}
          echo Common tree url: ${{ github.event.inputs.COMMON_TREE_URL }}
          echo Common tree branch: ${{ github.event.inputs.COMMON_TREE_BRANCH }}
          echo Device path: ${{ github.event.inputs.DEVICE_PATH }}
          echo Device name: ${{ github.event.inputs.DEVICE_NAME }}
          echo Lunch target: ${{ github.event.inputs.LUNCH_TARGET }}
          echo Build target: ${{ github.event.inputs.BUILD_PARTITION }}.img
          echo Build date: $(date)
          echo
          echo EOF
        } >> "$GITHUB_ENV"
        echo BUILD_DATE=$(date +%F) >> "$GITHUB_ENV"

    - name: Cleanup
      uses: rokibhasansagar/slimhub_actions@main

    - name: Maximize build space
      uses: easimon/maximize-build-space@master

    - name: Setup ccache (and cache)
      uses: actions/cache@v4
      with:
        path: |
          .ccache
        key: ${{ runner.os }}-ccache-${{ github.ref }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-
    - name: Enable ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        create-symlink: true

    - name: Setup zram
      run: |
        sudo apt update
        sudo apt install -y linux-modules-extra-$(uname -r) zram-tools || true
        sudo modprobe zram || true
        sudo sed -i 's/^#PERCENT=50/PERCENT=90/' /etc/default/zramswap || true
        sudo sed -i 's/^#PRIORITY=100/PRIORITY=1000/' /etc/default/zramswap || true
        sudo systemctl restart zramswap || true
        zramctl || true

    - name: Setup environment packages
      run: |
        export DEBIAN_FRONTEND=noninteractive
        sudo apt update && sudo apt upgrade -y
        sudo apt install -y repo git-core git python3 python3-pip curl
        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"

    - name: Repo init (TWRP manifest)
      run: |
        repo init -u "${{ github.event.inputs.TWRP_MANIFEST_URL }}" -b "${{ github.event.inputs.TWRP_MANIFEST_BRANCH }}" --depth=1

    - name: Repo sync (with timeout and parallel)
      run: |
        # 使用 timeout 防止无限等待（这里 120m = 2 小时，可按需调整）
        # 并行 -j6，限制为当前分支 -c，禁用 tags，安静输出
        timeout 120m repo sync -c -j6 --no-tags

    - name: Clone device tree (device specific)
      run: |
        mkdir -p device/${{ github.event.inputs.DEVICE_PATH }}
        # Clone device tree; 如果指定分支不存在会失败
        set -e
        git clone "${{ github.event.inputs.DEVICE_TREE_URL }}" -b "${{ github.event.inputs.DEVICE_TREE_BRANCH }}" "device/${{ github.event.inputs.DEVICE_PATH }}" || {
          echo "Failed to clone device tree with branch ${{ github.event.inputs.DEVICE_TREE_BRANCH }}. Try cloning default branch."
          git clone "${{ github.event.inputs.DEVICE_TREE_URL }}" "device/${{ github.event.inputs.DEVICE_PATH }}"
        }
    - name: Clone common tree (sm8650-common)
      run: |
        mkdir -p device/xiaomi/sm8650-common
        git clone "${{ github.event.inputs.COMMON_TREE_URL }}" -b "${{ github.event.inputs.COMMON_TREE_BRANCH }}" device/xiaomi/sm8650-common || {
          echo "Failed to clone common tree with branch ${{ github.event.inputs.COMMON_TREE_BRANCH }} — trying default branch"
          git clone "${{ github.event.inputs.COMMON_TREE_URL }}" device/xiaomi/sm8650-common
        }

    - name: Optional: clone kernel/vendor if provided
      run: |
        set -e
        if [ -n "${{ github.event.inputs.KERNEL_URL }}" ]; then
          echo "Cloning kernel ${GITHUB_EVENT_INPUTS_KERNEL_URL}"
          git clone "${{ github.event.inputs.KERNEL_URL }}" -b "${{ github.event.inputs.KERNEL_BRANCH }}" kernel || {
            echo "Kernel clone failed or branch not found — trying default branch"
            git clone "${{ github.event.inputs.KERNEL_URL }}" kernel || echo "Kernel clone failed completely"
          }
        else
          echo "No KERNEL_URL provided — skipping kernel clone"
        fi

        if [ -n "${{ github.event.inputs.VENDOR_URL }}" ]; then
          echo "Cloning vendor"
          git clone "${{ github.event.inputs.VENDOR_URL }}" -b "${{ github.event.inputs.VENDOR_BRANCH }}" vendor || {
            echo "Vendor clone failed or branch not found — trying default branch"
            git clone "${{ github.event.inputs.VENDOR_URL }}" vendor || echo "Vendor clone failed completely"
          }
        else
          echo "No VENDOR_URL provided — skipping vendor clone"
        fi

    - name: Quick fix: ensure BoardConfig / recovery.fstab exist (best-effort)
      run: |
        set -e
        DEV_DIR="device/${{ github.event.inputs.DEVICE_PATH }}"
        COMMON_DIR="device/xiaomi/sm8650-common"
        echo "Checking $DEV_DIR for BoardConfig* and recovery.fstab"
        if [ ! -f "$DEV_DIR/BoardConfig.mk" ] && [ -f "$COMMON_DIR/BoardConfig.mk" ]; then
          echo "BoardConfig.mk missing in device tree — copying from common"
          cp "$COMMON_DIR/BoardConfig.mk" "$DEV_DIR/" || true
        fi

        if [ ! -f "$DEV_DIR/recovery.fstab" ] && [ -f "$COMMON_DIR/recovery.fstab" ]; then
          echo "recovery.fstab missing in device tree — copying from common"
          cp "$COMMON_DIR/recovery.fstab" "$DEV_DIR/" || true
        fi

        # 若仍缺文件则列出路径方便排错
        echo "Device dir listing:"
        ls -la "$DEV_DIR" || true

    - name: Generate build INFO.txt
      working-directory: device/${{ github.event.inputs.DEVICE_PATH }}
      run: |
        echo -e "$BUILD_INFO" > INFO.txt
        echo "Change log:" >> INFO.txt
        set +e
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
        if [ $? -eq 0 ]; then
          git log "$LAST_TAG"..HEAD --pretty=format:"- %h-%an: %s" >> INFO.txt
        else
          git log --pretty=format:"- %h-%an: %s" >> INFO.txt
        fi
        cat INFO.txt

    - name: Setup build environment
      run: |
        source build/envsetup.sh || echo "envsetup.sh not found (repo sync failed?), continuing to fail later"
        export ALLOW_MISSING_DEPENDENCIES=true
        export CCACHE_DIR=.ccache
        export CCACHE_EXEC=$(command -v ccache || true)
        export USE_CCACHE=1
        export CCACHE_MAXSIZE=${{ env.CCACHE_MAXSIZE }}

    - name: Lunch and build
      run: |
        set -e
        # lunch target: twrp_<name>-userdebug or twrp_<name>
        echo "Using LUNCH_TARGET=${{ env.LUNCH_TARGET }}"
        lunch_target="twrp_${{ env.LUNCH_TARGET }}"
        echo "Lunching ${lunch_target}"
        lunch ${lunch_target} || {
          echo "lunch failed — try plain device name"
          lunch "twrp_${{ github.event.inputs.DEVICE_NAME }}" || {
            echo "lunch still failed — printing available lunch combos"
            lunch || true
            exit 1
          }
        }

        # build partition (recovery/boot/vendor_boot)
        BUILD_PART="${{ github.event.inputs.BUILD_PARTITION }}"
        echo "Building partition: ${BUILD_PART}"
        # Use m <partition>image (TWRP build system)
        if [ "${BUILD_PART}" = "recovery" ]; then
          m recoveryimage
        else
          m ${BUILD_PART}image || m ${BUILD_PART}
        fi

        OUT_IMG="out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${BUILD_PART}.img"
        if [ -f "${OUT_IMG}" ]; then
          DST="out/target/product/${{ github.event.inputs.DEVICE_NAME }}/TWRP-3.7.1-16-${{ github.event.inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}.img"
          mv "${OUT_IMG}" "${DST}"
          echo "Built image moved to ${DST}"
        else
          echo "Build finished but ${OUT_IMG} not found — build may have failed."
          ls -la out/target/product/${{ github.event.inputs.DEVICE_NAME }} || true
          exit 2
        fi

    - name: Create Release (upload image)
      uses: softprops/action-gh-release@v2
      with:
        files: |
          out/target/product/${{ github.event.inputs.DEVICE_NAME }}/TWRP-3.7.1-16-${{ github.event.inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}.img
        name: TWRP-3.7.1-16-${{ github.event.inputs.DEVICE_NAME }}-${{ env.BUILD_DATE }}-${{ github.run_id }}
        tag_name: ${{ env.BUILD_DATE }}-${{ github.run_id }}
        body_path: device/${{ github.event.inputs.DEVICE_PATH }}/INFO.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
